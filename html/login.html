<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="icon" href="/favicon/favicon.ico?v=2025.01.052353" type="image/x-icon">
  <title>HeyVoca</title>
  <!-- OS 함수 -->
  <script src="/js/osFunction.js?v=2025.01.052353"></script>
  <!-- sql.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js?v=2025.01.052353"></script>
  <!-- Indexed_DB -->
  <script src="/js/indexedDb.js?v=2025.01.052353"></script>
  <!-- 로그인 확인 -->
  <script src="/js/loginSession.js?v=2025.01.052353"></script>
  <link rel="stylesheet" href="/css/reset.css?v=2025.01.052353">
  <link rel="stylesheet" href="/css/common.css?v=2025.01.052353">
  <script src="/js/initStyle.js?v=2025.01.052353"></script>

  <link rel="stylesheet" href="/css/login.css?v=2025.01.052353">
  <!-- lottie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js?v=2025.01.052353"></script>

  <!-- FCM -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

</head> 
<body data-page="login">
  <div id="app">
    <div class="background">
      <!-- <img class="logo" src="/images/logo.png?v=2025.01.052353" alt=""> -->
      <div id="lottie-container" class="logo"></div>

      <div class="buttons">
        <button class="google_btn" onclick="clickGoogleLogin(event)">
          <img src="/images/google_logo.png?v=2025.01.052353" alt="">
          <span>Google 로그인</span>
        </button>
        <a class="non_members" href="#" onclick="clickNonMembers(event)">비회원 이용하기</a>
      </div>
    </div>
  </div>
  <script src="/js/common.js?v=2025.01.052353"></script>
  <script>
    lottie.loadAnimation({
      container: document.getElementById('lottie-container'),
      renderer: 'svg',
      loop: false,
      autoplay: true,
      path: '/lottie/heyvoca logo-01.json?v=2025.01.052353' // JSON 파일 경로를 입력하세요.
    });
    document.addEventListener('DOMContentLoaded', async (event) => {
      const user_data = JSON.parse(localStorage.getItem('user'));
      if(!user_data){
        localStorage.setItem('user', JSON.stringify({
          google_id : null,
          name : null,
          email : null,
          status : "logout",
        }))
      }
      if(user_data?.state == "login"){
        window.location.href = '/html/vocabulary_list.html';
      }

      const google_id = getValueFromURL('googleId');
 
      if(!google_id) return;
      const access_token = getValueFromURL('accessToken');
      const refresh_token = getValueFromURL('refreshToken');
      const email = getValueFromURL('email');
      const name = getValueFromURL('name');
      const status = getValueFromURL('status');
      const type = getValueFromURL('type');
      const user = {
        google_id : google_id,
        name : name,
        email : email,
        status : 'login',
      };
      
      if(user_data?.google_id != user.googleId){
        // 이미 기록된 사용자가 있을 경우
        // 데이터 삭제 경고, 백업 했는지 확인
        // deleteDatabase('HEY_VOCA_DB')
      }
      if(type == 'app'){
        const url = 'https://vocaandgo.ghmate.com/login/login_google/callback/app'
        const method = 'POST';
        const fetchData = {
          google_id : google_id,
          access_token : access_token,
          refresh_token : refresh_token,
          email : email,
          name : name
        }
        try{
          const result = await fetchDataAsync(url, method, fetchData);
          if(result.code != 200) return alert('로그인 중 오류가 발생하였습니다.');
        } catch (error) {
          return alert(JSON.stringify(error));          
        }
      }
      
      try{
        const result = await fetchDataAsync(url, method, fetchData);
        if(result.code !== 200){
          return alert(result.msg);
        }
      }catch(error){

      }
      localStorage.setItem('fcm_token', JSON.stringify(fcm_token));
      localStorage.setItem('user', JSON.stringify(user));
      window.location.href = '/html/vocabulary_list.html';
    });
    const clickGoogleLogin = () => {
      const device_type = getDevicePlatform();
      if(device_type == 'web'){
        window.location.href = 'https://vocaandgo.ghmate.com/login/google?device_type=web';
      }else{
        window.ReactNativeWebView.postMessage('launchGoogleAuth');
      }
    }
    const clickNonMembers = (event) => {
      localStorage.setItem('user', JSON.stringify({
        token : 1,
        email : 'guest@heyvoca.com',
        name : '비회원',
        status : "login",
      }))
      window.location.href = '/html/vocabulary_list.html';
    }

    
      const initFcm = async () => {
          
        const firebaseConfig = {
          apiKey: "AIzaSyDNZwiU38MuCRuMc57b_QrhdSPINiw50fA",
          authDomain: "vocaandgo.firebaseapp.com",
          projectId: "vocaandgo",
          storageBucket: "vocaandgo.firebasestorage.app",
          messagingSenderId: "1029120969045",
          appId: "1:1029120969045:web:ebbd89ce97284d630c07dc",
          measurementId: "G-Z2ZYSGNFQK"
        };
        // Firebase 초기화
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();

        // Firebase Messaging 초기화
        const messaging = firebase.messaging();

        // FCM 토큰 가져오기
        async function getFcmToken() {
          try {
            // VAPID 키와 함께 FCM 토큰 요청
            const currentToken = await messaging.getToken({ vapidKey: 'BLZU6AG9inR6Q_aNw4G-fNrH0eHfDn_YvpEMM0FzvkZ1hwNQfB0uoXy7EFq-AC749ZFRqKiWu91CyP_RCGBMQn8' });
            if (currentToken) {
              return currentToken; // 토큰 반환
            } else {
              console.warn('사용 가능한 등록 토큰이 없습니다..');
              return null; // 토큰이 없으면 null 반환
            }
          } catch (err) {
            console.error('토큰을 검색하는 중 오류가 발생했습니다..', err);
            return null; // 에러 발생 시 null 반환
          }
        }
        const fcm_token = await getFcmToken();
        console.log(fcm_token)
        // const url = `https://vocaandgo.ghmate.com/fcm/save_token`;
        // const method = 'POST';
        // const fetchData = {
        //   fcm_token : fcm_token,
        //   google_id : google_id
        // }
      }
      initFcm();
  </script>
</body>
</html>